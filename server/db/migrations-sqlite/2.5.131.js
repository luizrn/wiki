exports.up = async knex => {
  await knex.schema
    .createTable('boards', table => {
      table.increments('id').primary()
      table.string('title').notNullable()
      table.text('description')
      table.string('color').notNullable().defaultTo('#1976d2')
      table.string('icon').notNullable().defaultTo('mdi-view-kanban')
      table.boolean('isArchived').notNullable().defaultTo(false)
      table.boolean('isPublic').notNullable().defaultTo(false)
      table.json('settings')
      table.integer('createdById').unsigned().references('id').inTable('users')
      table.string('createdAt').notNullable()
      table.string('updatedAt').notNullable()
    })
    .createTable('boardGroups', table => {
      table.increments('id').primary()
      table.integer('boardId').unsigned().notNullable().references('id').inTable('boards').onDelete('CASCADE')
      table.integer('groupId').unsigned().notNullable().references('id').inTable('groups').onDelete('CASCADE')
      table.string('accessLevel').notNullable().defaultTo('edit')
      table.unique(['boardId', 'groupId'])
      table.index(['boardId'], 'boardgroups_board_idx')
      table.index(['groupId'], 'boardgroups_group_idx')
    })
    .createTable('boardTeams', table => {
      table.increments('id').primary()
      table.string('name').notNullable()
      table.text('description')
      table.string('color').notNullable().defaultTo('#546e7a')
      table.boolean('isArchived').notNullable().defaultTo(false)
      table.integer('createdById').unsigned().references('id').inTable('users')
      table.string('createdAt').notNullable()
      table.string('updatedAt').notNullable()
    })
    .createTable('boardTeamUsers', table => {
      table.increments('id').primary()
      table.integer('teamId').unsigned().notNullable().references('id').inTable('boardTeams').onDelete('CASCADE')
      table.integer('userId').unsigned().notNullable().references('id').inTable('users').onDelete('CASCADE')
      table.string('role').notNullable().defaultTo('member')
      table.unique(['teamId', 'userId'])
      table.index(['teamId'], 'boardteamusers_team_idx')
      table.index(['userId'], 'boardteamusers_user_idx')
    })
    .createTable('boardTeamBoards', table => {
      table.increments('id').primary()
      table.integer('teamId').unsigned().notNullable().references('id').inTable('boardTeams').onDelete('CASCADE')
      table.integer('boardId').unsigned().notNullable().references('id').inTable('boards').onDelete('CASCADE')
      table.unique(['teamId', 'boardId'])
      table.index(['teamId'], 'boardteamboards_team_idx')
      table.index(['boardId'], 'boardteamboards_board_idx')
    })
    .createTable('boardStages', table => {
      table.increments('id').primary()
      table.integer('boardId').unsigned().notNullable().references('id').inTable('boards').onDelete('CASCADE')
      table.string('title').notNullable()
      table.string('color').notNullable().defaultTo('#90a4ae')
      table.integer('position').notNullable().defaultTo(0)
      table.integer('wipLimit')
      table.boolean('isDone').notNullable().defaultTo(false)
      table.string('createdAt').notNullable()
      table.string('updatedAt').notNullable()
      table.index(['boardId', 'position'], 'boardstages_board_pos_idx')
    })
    .createTable('boardCards', table => {
      table.increments('id').primary()
      table.integer('boardId').unsigned().notNullable().references('id').inTable('boards').onDelete('CASCADE')
      table.integer('stageId').unsigned().notNullable().references('id').inTable('boardStages').onDelete('CASCADE')
      table.string('title').notNullable()
      table.text('description')
      table.integer('position').notNullable().defaultTo(0)
      table.string('priority').notNullable().defaultTo('medium')
      table.string('status').notNullable().defaultTo('open')
      table.string('startDate')
      table.string('dueDate')
      table.string('completedAt')
      table.integer('assigneeId').unsigned().references('id').inTable('users')
      table.integer('reporterId').unsigned().references('id').inTable('users')
      table.integer('estimatePoints')
      table.string('coverColor')
      table.boolean('isArchived').notNullable().defaultTo(false)
      table.json('labels')
      table.json('checklist')
      table.json('attachments')
      table.json('watchers')
      table.json('customFields')
      table.string('createdAt').notNullable()
      table.string('updatedAt').notNullable()
      table.index(['boardId', 'stageId', 'position'], 'boardcards_board_stage_pos_idx')
      table.index(['boardId', 'dueDate'], 'boardcards_board_due_idx')
      table.index(['assigneeId'], 'boardcards_assignee_idx')
    })
}

exports.down = async knex => {
  await knex.schema
    .dropTableIfExists('boardCards')
    .dropTableIfExists('boardStages')
    .dropTableIfExists('boardTeamBoards')
    .dropTableIfExists('boardTeamUsers')
    .dropTableIfExists('boardTeams')
    .dropTableIfExists('boardGroups')
    .dropTableIfExists('boards')
}
